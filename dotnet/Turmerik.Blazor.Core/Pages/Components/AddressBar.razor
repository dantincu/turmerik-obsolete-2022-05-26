@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using Turmerik.AspNetCore.Infrastructure
@using System.Web;
@using Turmerik.Core.Helpers;

@inherits ComponentCoreBase;
@inject IJSRuntime JSRuntime;

<div id="@UuidStr" class="@CssClassH.AddressBarContainer">
    <IconButton IsDisabled=@AddressGoBackBtnDisabled CssClass="oi oi-arrow-circle-left" Title="Go Back" OnMouseUp=@OnGoBackMouseUpAsyncEventHandler></IconButton>
    <IconButton IsDisabled=@AddressGoParentBtnDisabled CssClass="oi oi-arrow-circle-top" Title="Go Up" OnMouseUp=@OnGoUpMouseUpAsyncEventHandler></IconButton>

    <IconButton IsDisabled=@AddressGoForwardBtnDisabled CssClass="oi oi-arrow-circle-right" Title="Go Forward" OnMouseUp=@OnGoForwardMouseUpAsyncEventHandler></IconButton>

    <input type="text" value="@InitialAddressStrValue" class="@CssClassH.AddressBar @CssClassH.Hidden" @onfocus=@OnAddressBarFocusAsync @onkeydown=@OnAddressBarKeyDownAsyncEventHandler />
    <input type="text" readonly value="@InitialAddressStrValue" class="@CssClassH.AddressBarReadonly" @onclick=@OnAddressBarReadonlyClickAsyncEventHandler></input>

    <IconButton CssClass="oi oi-ellipses trmrk-rotate90deg" Title="Options" OnMouseUp=@OnOptionsMouseUpAsyncEventHandler></IconButton>
    
    <IconButton CssClass="oi oi-arrow-circle-right" Title="Go to address" OnMouseUp=@OnGoToAddressMouseUpAsyncEventHandler></IconButton>
    <IconButton CssClass="oi oi-reload" Title="Reload" OnMouseUp=@OnReloadMouseUpAsyncEventHandler></IconButton>
</div>

@code {
    [Parameter]
    public string InitialAddressStrValue { get; set; }

    [Parameter]
    public Func<MouseEventArgs, Task> OnGoBackClick { get; set; }

    [Parameter]
    public Func<MouseEventArgs, Task> OnGoUpClick { get; set; }

    [Parameter]
    public Func<MouseEventArgs, Task> OnGoForwardClick { get; set; }

    [Parameter]
    public Func<TextEventArgsWrapper, Task> OnSubmitAddress { get; set; }

    [Parameter]
    public Func<TextEventArgsWrapper, Task> OnCancelAddress { get; set; }

    [Parameter]
    public Func<MouseEventArgs, Task> OnOptionsClick { get; set; }

    [Parameter]
    public Func<MouseEventArgs, Task> OnReloadClick { get; set; }

    [Parameter]
    public bool AddressGoBackBtnDisabled { get; set; }

    [Parameter]
    public bool AddressGoParentBtnDisabled { get; set; }

    [Parameter]
    public bool AddressGoForwardBtnDisabled { get; set; }

    protected string AddressStrValue { get; set; }

    protected async Task OnAddressBarFocusAsync(FocusEventArgs args)
    {
        AddressStrValue = await JSRuntime.InvokeAsync<string>(
            JsH.Get(JsH.SelectDomEl),
            UuidStr,
            CssClassH.AddressBar.CssClsSel());
    }

    protected async Task OnAddressBarKeyDownAsyncEventHandler(KeyboardEventArgs args)
    {
        switch (args.Code)
        {
            case KeyboardKeyCodes.ENTER:
                await SubmitAddress(args);
                break;
            case KeyboardKeyCodes.ESCAPE:
                await CancelAddress(args);
                break;
        }
    }

    protected async Task OnGoBackMouseUpAsyncEventHandler(MouseEventArgs args)
    {
        await OnGoBackClick.InvokeMouseClickAsyncIfLeftBtn(args);
    }

    protected async Task OnGoUpMouseUpAsyncEventHandler(MouseEventArgs args)
    {
        await OnGoUpClick.InvokeMouseClickAsyncIfLeftBtn(args);
    }

    protected async Task OnGoForwardMouseUpAsyncEventHandler(MouseEventArgs args)
    {
        await OnGoForwardClick.InvokeMouseClickAsyncIfLeftBtn(args);
    }

    protected async Task OnOptionsMouseUpAsyncEventHandler(MouseEventArgs args)
    {
        await OnOptionsClick.InvokeMouseClickAsyncIfLeftBtn(args);
    }

    protected async Task OnGoToAddressMouseUpAsyncEventHandler(MouseEventArgs args)
    {
        if (args.Button.IsLeftMouseButton())
        {
            await SubmitAddress(args);
        }
    }

    protected async Task OnReloadMouseUpAsyncEventHandler(MouseEventArgs args)
    {
        await OnReloadClick.InvokeMouseClickAsyncIfLeftBtn(args);
    }

    protected async Task OnAddressBarReadonlyClickAsyncEventHandler(MouseEventArgs args)
    {
        await SetEditable(true);
    }

    protected async Task<string> RefreshAddressStrValue()
    {
        AddressStrValue = await JSRuntime.InvokeAsync<string>(
            JsH.Get(JsH.GetDomElValue),
            UuidStr,
            CssClassH.AddressBar.CssClsSel());

        return AddressStrValue;
    }

    protected async Task<string> SetEditable(bool editable, bool revertChanges = false)
    {
        AddressStrValue = await JSRuntime.InvokeAsync<string>(
            JsH.Get(JsH.TextBoxWrapperSetEditable),
            UuidStr,
            CssClassH.AddressBar.CssClsSel(),
            CssClassH.AddressBarReadonly.CssClsSel(),
            editable,
            revertChanges);

        return AddressStrValue;
    }

    protected async Task<string> SubmitAddress(EventArgs args)
    {
        await SetEditable(false);

        if (OnSubmitAddress != null)
        {
            var eventArgs = new TextEventArgsWrapper(args, AddressStrValue);
            await OnSubmitAddress.Invoke(eventArgs);
        }

        return AddressStrValue;
    }

    protected async Task<string> CancelAddress(EventArgs args)
    {
        await SetEditable(false, true);

        if (OnCancelAddress != null)
        {
            var eventArgs = new TextEventArgsWrapper(args, AddressStrValue);
            await OnCancelAddress.Invoke(eventArgs);
        }

        return AddressStrValue;
    }
}
