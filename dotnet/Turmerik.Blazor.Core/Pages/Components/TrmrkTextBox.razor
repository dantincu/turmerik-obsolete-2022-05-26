@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using Turmerik.AspNetCore.Infrastructure

@inherits ComponentCoreBase

@inject IJSRuntime JSRuntime;

<div id="@UuidStr" class="@CssClassH.TextboxWrapper @ComponentCssClass">
    @if (IsEditingText)
    {
        <span class="oi oi-arrow-circle-left" @onmouseup=OnCancelTextboxBtnClickAsync></span>
    }
    
    <input type="text" value="@EditableTextValue" class="@CssClassH.Textbox @EditableTextboxCssClass" @onfocus=@OnTextboxFocusAsync @onkeydown=@OnTextboxKeyDownAsync />
    <input type="text" readonly value="@TextValue" class="@CssClassH.TextboxReadonly @ReadonlyTextboxCssClass" @onclick=@OnTextboxReadonlyClickAsync />

    @if (IsEditingText)
    {
        <span class="oi oi-x" @onmouseup=OnClearTextboxBtnClickAsync></span>
        <span class="oi oi-arrow-circle-right" @onmouseup=SubmitTextbox></span>
    }
</div>

@code {
    [Parameter]
    public string ComponentCssClass { get; set; }

    [Parameter]
    public string TextValue { get; set; }

    [Parameter]
    public Func<TextEventArgsWrapper, Task> OnEnterTextBox { get; set; }

    [Parameter]
    public Func<TextEventArgsWrapper, Task> OnSubmitTextBox { get; set; }

    [Parameter]
    public Func<TextEventArgsWrapper, Task> OnCancelTextBox { get; set; }

    [Parameter]
    public bool IsEditingText { get; set; }

    private string EditableTextValue { get; set; }

    private string ReadonlyTextboxCssClass => IsEditingText ? CssClassH.Hidden : string.Empty;
    private string EditableTextboxCssClass => IsEditingText ? string.Empty : CssClassH.Hidden;

    private async Task OnCancelTextboxBtnClickAsync(MouseEventArgs args)
    {
        EditableTextValue = TextValue;
        IsEditingText = false;

        await OnCancelTextBox.InvokeTextEventAsyncIfReq(
            TextValue,
            args);
    }

    private async Task OnClearTextboxBtnClickAsync(MouseEventArgs args)
    {
        EditableTextValue = string.Empty;
    }

    private async Task OnTextboxFocusAsync(FocusEventArgs args)
    {
        await SelectEditableTextBoxAsync();
    }

    private async Task OnTextboxKeyDownAsync(KeyboardEventArgs args)
    {
        switch (args.Code)
        {
            case KeyboardKeyCodes.ENTER:
                await SubmitTextbox(args);
                break;
            case KeyboardKeyCodes.ESCAPE:
                await CancelTextbox(args);
                break;
        }
    }

    private async Task OnTextboxReadonlyClickAsync(MouseEventArgs args)
    {
        EditableTextValue = TextValue;
        IsEditingText = true;

        await OnEnterTextBox.InvokeTextEventAsyncIfReq(
            TextValue,
            args,
            args.Button.IsLeftMouseButton());
    }

    private async Task SubmitTextbox(EventArgs args)
    {
        EditableTextValue = await JSRuntime.InvokeAsync<string>(
            TrmrkJsH.Get(TrmrkJsH.GetDomElValue),
            UuidStr, CssClassH.Textbox.CssClsSel());

        TextValue = EditableTextValue;
        IsEditingText = false;

        await OnSubmitTextBox.InvokeTextEventAsyncIfReq(
            TextValue,
            args);
    }

    private async Task CancelTextbox(EventArgs args)
    {
        EditableTextValue = TextValue;
        IsEditingText = true;

        await OnCancelTextBox.InvokeTextEventAsyncIfReq(
            TextValue,
            args);
    }

    private async Task SelectEditableTextBoxAsync()
    {
        await JSRuntime.InvokeAsync<string>(
            TrmrkJsH.Get(TrmrkJsH.SelectDomEl),
            UuidStr,
            CssClassH.Textbox.CssClsSel());
    }
}
